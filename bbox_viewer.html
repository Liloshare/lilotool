<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBox Viewer</title>
<style>
  :root{
    --bg: #f4f6fb;
    --text: #111827;
    --muted: rgba(17,24,39,0.55);
    --border: rgba(17,24,39,0.10);
    --card: rgba(255,255,255,0.78);
    --card-strong: rgba(255,255,255,0.88);
    --shadow: 0 18px 45px rgba(17,24,39,0.12);
    --shadow-hover: 0 26px 70px rgba(17,24,39,0.16);
    --radius: 22px;

    --accent: rgba(17,24,39,0.92);          /* ê¸°ë³¸ ë²„íŠ¼(ë‹¤í¬) */
    --accent-hover: rgba(17,24,39,0.86);
    --accent-soft: rgba(167,139,250,0.22);  /* ì„ íƒ/ë°°ì§€ */
    --accent-text: rgba(99,102,241,1);
  }

  *{ margin:0; padding:0; box-sizing:border-box; }

  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Malgun Gothic", sans-serif;
    background:
      radial-gradient(1200px 600px at 15% 10%, rgba(167,139,250,0.18), transparent 55%),
      radial-gradient(900px 500px at 85% 15%, rgba(56,189,248,0.16), transparent 55%),
      radial-gradient(1000px 600px at 70% 85%, rgba(251,113,133,0.14), transparent 55%),
      var(--bg);
    height: 100vh;
    overflow: hidden;
    color: var(--text);
  }

  .container{
    display:flex;
    flex-direction:column;
    height:100vh;
    padding: 14px;
    gap: 12px;
  }

  /* ìƒë‹¨ íˆ´ë°” = ê¸€ë˜ìŠ¤ ì¹´ë“œ */
  .toolbar{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 12px;
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    position: relative;
    overflow: hidden;
  }
  .toolbar::before{
    content:;
    position:absolute;
    inset:-2px -2px auto -2px;
    height: 70px;
    background: linear-gradient(135deg,
      rgba(167,139,250,0.35),
      rgba(56,189,248,0.30),
      rgba(251,113,133,0.22)
    );
    opacity: .85;
    pointer-events:none;
  }
  .toolbar > *{ position:relative; z-index:1; }

  /* ë²„íŠ¼ */
  .btn{
   background: rgba(255,255,255,0.80);
    color: rgba(17,24,39,0.80);
    border: 1px solid rgba(17,24,39,0.10);
    padding: 10px 16px;
    border-radius: 16px;
    cursor: pointer;
    font-weight: 800;
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    box-shadow: 0 10px 24px rgba(17,24,39,0.12);
  }
  .btn:hover{
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 14px 34px rgba(17,24,39,0.16);
  }
  .btn.secondary{
    background: rgba(255,255,255,0.80);
    color: rgba(17,24,39,0.80);
    border: 1px solid rgba(17,24,39,0.10);
  }
  .btn.secondary:hover{
    background: rgba(255,255,255,0.92);
  }

  .main{
    display:flex;
    flex:1;
    overflow:hidden;
    gap: 12px;
  }

  /* ì‚¬ì´ë“œë°” = ê¸€ë˜ìŠ¤ ì¹´ë“œ */
  .sidebar{
    width: 320px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow-y:auto;
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }

  .image-list{ list-style:none; padding: 8px; }

  .image-item{
    padding: 12px 12px;
    cursor:pointer;
    transition: transform .15s ease, background .15s ease, border-color .15s ease;
    font-size: 13px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-radius: 16px;
    border: 1px solid transparent;
    color: rgba(17,24,39,0.78);
  }
  .image-item:hover{
    background: rgba(255,255,255,0.55);
    border-color: rgba(17,24,39,0.06);
    transform: translateY(-1px);
  }
  .image-item.active{
    background: var(--accent-soft);
    border-color: rgba(99,102,241,0.18);
    color: rgba(17,24,39,0.88);
    font-weight: 800;
  }

  .image-name{
    flex:1;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .annotation-badge{
    background: rgba(255,255,255,0.70);
    color: rgba(17,24,39,0.70);
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 800;
    margin-left: 8px;
    flex-shrink:0;
    border: 1px solid rgba(17,24,39,0.08);
  }
  .image-item.active .annotation-badge{
    background: rgba(17,24,39,0.88);
    color: white;
    border-color: rgba(17,24,39,0.10);
  }

  /* ìº”ë²„ìŠ¤ ì˜ì—­ */
  .canvas-container{
    flex:1;
    position:relative;
    overflow:auto;
    display:flex;
    align-items:center;
    justify-content:center;

    background:
      radial-gradient(900px 520px at 20% 15%, rgba(167,139,250,0.18), transparent 60%),
      radial-gradient(800px 520px at 80% 20%, rgba(56,189,248,0.16), transparent 60%),
      radial-gradient(900px 520px at 70% 85%, rgba(251,113,133,0.12), transparent 60%),
      rgba(17,24,39,0.92);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  canvas{
    max-width:100%;
    max-height:100%;
    display:block;
    border-radius: 14px;
    box-shadow: 0 18px 55px rgba(0,0,0,0.35);
  }

  /* ìƒíƒœ í† ìŠ¤íŠ¸ */
  .status{
    position:absolute;
    top: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.88);
    padding: 10px 14px;
    border-radius: 999px;
    box-shadow: 0 14px 34px rgba(17,24,39,0.14);
    display:none;
    z-index:100;
    border: 1px solid rgba(17,24,39,0.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-weight: 800;
    font-size: 12px;
  }
  .status.show{ display:block; }
  .status.error{
    background: rgba(251,113,133,0.18);
    color: rgba(190, 18, 60, 1);
    border-color: rgba(190,18,60,0.18);
  }
  .status.success{
    background: rgba(34,197,94,0.14);
    color: rgba(22,101,52,1);
    border-color: rgba(22,101,52,0.14);
  }

  input[type="file"]{ display:none; }

  /* legend íŒ¨ë„ */
  .legend{
    position:absolute;
    top: 18px;
    right: 18px;
    background: rgba(255,255,255,0.80);
    padding: 14px;
    border-radius: 18px;
    box-shadow: 0 18px 45px rgba(17,24,39,0.12);
    max-height: 400px;
    overflow-y:auto;
    display:none;
    border: 1px solid rgba(17,24,39,0.10);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
  .legend.show{ display:block; }
  .legend-title{
    font-weight: 900;
    margin-bottom: 10px;
    font-size: 13px;
    color: rgba(17,24,39,0.80);
  }
  .legend-item{
    display:flex;
    align-items:center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
    color: rgba(17,24,39,0.70);
  }
  .legend-color{
    width: 18px;
    height: 18px;
    border-radius: 7px;
    border: 1px solid rgba(17,24,39,0.18);
  }

  /* info íŒ¨ë„ */
  .info-panel{
    position:absolute;
    bottom: 18px;
    left: 18px;
    background: rgba(255,255,255,0.82);
    padding: 12px 14px;
    border-radius: 18px;
    font-size: 12px;
    box-shadow: 0 18px 45px rgba(17,24,39,0.12);
    border: 1px solid rgba(17,24,39,0.10);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    color: rgba(17,24,39,0.78);
  }
  .info-item{ margin-bottom: 4px; }
  .info-item:last-child{ margin-bottom:0; }
  .current-annotation-count{
    color: rgba(17,24,39,0.92);
    font-weight: 900;
    font-size: 14px;
  }

  /* í‚¤ë³´ë“œ íŒíŠ¸ */
  .keyboard-hint{
    position:absolute;
    bottom: 18px;
    right: 18px;
    background: rgba(255,255,255,0.72);
    padding: 10px 12px;
    border-radius: 18px;
    font-size: 12px;
    color: rgba(17,24,39,0.55);
    box-shadow: 0 18px 45px rgba(17,24,39,0.12);
    border: 1px solid rgba(17,24,39,0.10);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }

  /* ëª¨ë‹¬ */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background: rgba(17,24,39,0.28);
    z-index:1000;
    justify-content:center;
    align-items:center;
    padding: 16px;
  }
  .modal.show{ display:flex; }

  .modal-content{
    width: min(420px, 100%);
    background: rgba(255,255,255,0.86);
    border-radius: 24px;
    padding: 22px;
    box-shadow: 0 30px 90px rgba(17,24,39,0.22);
    border: 1px solid rgba(17,24,39,0.10);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    position:relative;
    overflow:hidden;
  }
  .modal-content::before{
    content:"";
    position:absolute;
    inset:-2px -2px auto -2px;
    height: 84px;
    background: linear-gradient(135deg,
      rgba(167,139,250,0.35),
      rgba(56,189,248,0.30),
      rgba(251,113,133,0.22)
    );
    opacity:.85;
    pointer-events:none;
  }
  .modal-content > *{ position:relative; z-index:1; }

  .modal-title{
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 14px;
    text-align:center;
    color: rgba(17,24,39,0.90);
  }

  .modal-buttons{ display:flex; gap: 10px; }

  .modal-btn{
    flex:1;
    padding: 12px;
    border: 1px solid rgba(17,24,39,0.10);
    border-radius: 18px;
    font-weight: 900;
    cursor:pointer;
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    background: rgba(255,255,255,0.82);
    color: rgba(17,24,39,0.80);
    box-shadow: 0 12px 28px rgba(17,24,39,0.10);
  }
  .modal-btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 16px 38px rgba(17,24,39,0.14);
  }
  .modal-btn.primary{
    background: rgba(17,24,39,0.92);
    color:white;
    border-color: rgba(17,24,39,0.12);
  }
  .modal-btn.primary:hover{ background: rgba(17,24,39,0.86); }
</style>
```

</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button class="btn" id="btnLoadJson">ğŸ“„ 1.json ì„ íƒ</button>
            <button class="btn secondary" id="btnLoadImages">ğŸ–¼ï¸ 2.ì´ë¯¸ì§€ ì„ íƒ</button>
        </div>

        <div class="main">
            <div class="sidebar">
                <ul class="image-list" id="imageList"></ul>
            </div>

            <div class="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="status" id="status">ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="legend" id="legend">
                    <div class="legend-title">í´ë˜ìŠ¤ ë²”ë¡€</div>
                    <div id="legendContent"></div>
                </div>
                <div class="info-panel" id="infoPanel" style="display: none;">
                    <div class="info-item"><strong>ì „ì²´ ì´ë¯¸ì§€:</strong> <span id="jsonCount">0</span>ê°œ</div>
                    <div class="info-item"><strong>ì „ì²´ ì–´ë…¸í…Œì´ì…˜:</strong> <span id="annotationCount">0</span>ê°œ</div>
                    <div class="info-item"><strong>í˜„ì¬ ì´ë¯¸ì§€:</strong> <span class="current-annotation-count" id="currentAnnotationCount">-</span>ê°œ</div>
                </div>
                <div class="keyboard-hint">
                    â¬†ï¸ â¬‡ï¸ ì´ë¯¸ì§€ ì´ë™
                </div>
            </div>
        </div>
    </div>

    <!-- ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal" id="jsonModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“„ JSON ì„ íƒ ë°©ì‹</div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="btnJsonFiles">íŒŒì¼ ì„ íƒ</button>
                <button class="modal-btn primary" id="btnJsonFolder">í´ë” ì„ íƒ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì„ íƒ ë°©ì‹</div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="btnImageFiles">íŒŒì¼ ì„ íƒ</button>
                <button class="modal-btn primary" id="btnImageFolder">í´ë” ì„ íƒ</button>
            </div>
        </div>
    </div>

    <script>
        let imageFiles = {};
        let annotationsByImage = {};
        let classMap = {};
        let imageList = {};
        let colorMap = {};
        let allAnnotations = [];
        let currentImageIndex = -1;
        let imageIdArray = [];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageListEl = document.getElementById('imageList');
        const status = document.getElementById('status');
        const legend = document.getElementById('legend');
        const legendContent = document.getElementById('legendContent');
        const infoPanel = document.getElementById('infoPanel');
        const jsonModal = document.getElementById('jsonModal');
        const imageModal = document.getElementById('imageModal');

        function resetAll() {
            imageFiles = {};
            annotationsByImage = {};
            classMap = {};
            imageList = {};
            colorMap = {};
            allAnnotations = [];
            currentImageIndex = -1;
            imageIdArray = [];
            
            imageListEl.innerHTML = '';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legend.classList.remove('show');
            infoPanel.style.display = 'none';
        }

        document.addEventListener('keydown', (e) => {
            if (imageIdArray.length === 0) return;

            if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateImage(-1);
            } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                e.preventDefault();
                navigateImage(1);
            }
        });

        function navigateImage(direction) {
            if (imageIdArray.length === 0) return;

            currentImageIndex += direction;

            if (currentImageIndex < 0) {
                currentImageIndex = 0;
            } else if (currentImageIndex >= imageIdArray.length) {
                currentImageIndex = imageIdArray.length - 1;
            }

            const imgId = imageIdArray[currentImageIndex];
            const fileName = imageList[imgId];
            displayImage(imgId, fileName);

            const activeItem = document.querySelector('.image-item.active');
            if (activeItem) {
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // JSON ì„ íƒ ë²„íŠ¼
        document.getElementById('btnLoadJson').addEventListener('click', () => {
            jsonModal.classList.add('show');
        });

        // ì´ë¯¸ì§€ ì„ íƒ ë²„íŠ¼
        document.getElementById('btnLoadImages').addEventListener('click', () => {
            imageModal.classList.add('show');
        });

        // JSON íŒŒì¼ ì„ íƒ
        document.getElementById('btnJsonFiles').addEventListener('click', () => {
            jsonModal.classList.remove('show');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            input.multiple = true;
            
            input.onchange = async (e) => {
                resetAll();
                const files = Array.from(e.target.files);
                await loadAnnotationFiles(files);
            };
            
            input.click();
        });

        // JSON í´ë” ì„ íƒ
        document.getElementById('btnJsonFolder').addEventListener('click', () => {
            jsonModal.classList.remove('show');
            const input = document.createElement('input');
            input.type = 'file';
            input.setAttribute('webkitdirectory', '');
            input.setAttribute('directory', '');
            
            input.onchange = async (e) => {
                resetAll();
                const files = Array.from(e.target.files);
                await loadAnnotationFiles(files);
            };
            
            input.click();
        });

        // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
        document.getElementById('btnImageFiles').addEventListener('click', () => {
            imageModal.classList.remove('show');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                loadImageFiles(files);
            };
            
            input.click();
        });

        // ì´ë¯¸ì§€ í´ë” ì„ íƒ
        document.getElementById('btnImageFolder').addEventListener('click', () => {
            imageModal.classList.remove('show');
            const input = document.createElement('input');
            input.type = 'file';
            input.setAttribute('webkitdirectory', '');
            input.setAttribute('directory', '');
            
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                loadImageFiles(files);
            };
            
            input.click();
        });

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        jsonModal.addEventListener('click', (e) => {
            if (e.target === jsonModal) {
                jsonModal.classList.remove('show');
            }
        });

        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                imageModal.classList.remove('show');
            }
        });

        async function loadAnnotationFiles(files) {
            if (!files || files.length === 0) return;

            let jsonCount = 0;
            let yoloCount = 0;
            let labelmeCount = 0;

            for (const file of files) {
                if (file.name.endsWith('.json')) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        // LabelMe format
                        if (data.shapes && data.imagePath) {
                            labelmeCount++;
                            const baseName = file.name.replace('.json', '');
                            const imgPath = data.imagePath.split('/').pop().split('.')[0];
                            
                            if (!annotationsByImage[imgPath]) {
                                annotationsByImage[imgPath] = [];
                            }

                            data.shapes.forEach((shape, idx) => {
                                if (shape.shape_type === 'rectangle' && shape.points.length === 2) {
                                    const [[x1, y1], [x2, y2]] = shape.points;
                                    const x = Math.min(x1, x2);
                                    const y = Math.min(y1, y2);
                                    const w = Math.abs(x2 - x1);
                                    const h = Math.abs(y2 - y1);
                                    
                                    const label = shape.label || 'unknown';
                                    let classId = Object.keys(classMap).find(id => classMap[id] === label);
                                    if (!classId) {
                                        classId = Object.keys(classMap).length;
                                        classMap[classId] = label;
                                    }

                                    const ann = {
                                        id: `${imgPath}_${idx}`,
                                        image_id: imgPath,
                                        category_id: parseInt(classId),
                                        bbox: [x, y, w, h],
                                        label: label
                                    };
                                    
                                    annotationsByImage[imgPath].push(ann);
                                    allAnnotations.push(ann);
                                }
                            });

                            imageList[imgPath] = data.imagePath;
                        }
                        // COCO format
                        else if (data.annotations && Array.isArray(data.annotations)) {
                            jsonCount++;
                            data.annotations.forEach(ann => {
                                const imgId = String(ann.image_id);
                                if (!annotationsByImage[imgId]) {
                                    annotationsByImage[imgId] = [];
                                }
                                annotationsByImage[imgId].push(ann);
                                allAnnotations.push(ann);
                            });

                            if (data.categories && Array.isArray(data.categories)) {
                                data.categories.forEach(cat => {
                                    classMap[cat.id] = cat.name;
                                });
                            }

                            if (data.images && Array.isArray(data.images)) {
                                data.images.forEach(img => {
                                    imageList[String(img.id)] = img.file_name;
                                });
                            }
                        }
                        // Custom format
                        else if (data.object_annotation && Array.isArray(data.object_annotation)) {
                            jsonCount++;
                            data.object_annotation.forEach(obj => {
                                const imgId = String(obj.image_id);
                                if (!annotationsByImage[imgId]) {
                                    annotationsByImage[imgId] = [];
                                }
                                annotationsByImage[imgId].push(obj);
                                allAnnotations.push(obj);
                                imageList[imgId] = imgId;
                            });
                        }
                    } catch (err) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', file.name, err);
                    }
                }
                // YOLO TXT
                else if (file.name.endsWith('.txt')) {
                    try {
                        const text = await file.text();
                        const lines = text.trim().split('\n');
                        const baseName = file.name.replace('.txt', '');
                        
                        if (lines.length > 0 && lines[0].trim() !== '') {
                            yoloCount++;
                            
                            if (!annotationsByImage[baseName]) {
                                annotationsByImage[baseName] = [];
                            }

                            lines.forEach((line, idx) => {
                                const parts = line.trim().split(/\s+/);
                                if (parts.length >= 5) {
                                    const [classId, centerX, centerY, width, height] = parts.map(Number);
                                    
                                    const ann = {
                                        id: `${baseName}_${idx}`,
                                        image_id: baseName,
                                        category_id: classId,
                                        class_id: classId,
                                        yolo: [centerX, centerY, width, height]
                                    };
                                    
                                    annotationsByImage[baseName].push(ann);
                                    allAnnotations.push(ann);
                                    
                                    if (!classMap[classId]) {
                                        classMap[classId] = `Class ${classId}`;
                                    }
                                }
                            });

                            imageList[baseName] = baseName;
                        }
                    } catch (err) {
                        console.error('YOLO íŒŒì‹± ì˜¤ë¥˜:', file.name, err);
                    }
                }
            }

            imageIdArray = Object.keys(imageList).sort();

            if (jsonCount > 0 || yoloCount > 0 || labelmeCount > 0) {
                const msg = [];
                if (jsonCount > 0) msg.push(`COCO ${jsonCount}ê°œ`);
                if (labelmeCount > 0) msg.push(`LabelMe ${labelmeCount}ê°œ`);
                if (yoloCount > 0) msg.push(`YOLO ${yoloCount}ê°œ`);
                showStatus(`âœ“ ${msg.join(', ')} ë¡œë“œ ì™„ë£Œ`, 'success');
                updateImageList();
                updateLegend();
                updateInfo();
            } else {
                showStatus('ì–´ë…¸í…Œì´ì…˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        function loadImageFiles(files) {
            if (!files || files.length === 0) return;

            let count = 0;
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(file.name)) {
                    const name = file.name.split('.')[0];
                    imageFiles[name] = file;
                    count++;
                }
            });

            if (count > 0) {
                showStatus(`âœ“ ì´ë¯¸ì§€ ${count}ê°œ ë¡œë“œ ì™„ë£Œ`, 'success');
                updateInfo();
            } else {
                showStatus('ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        function updateImageList() {
            imageListEl.innerHTML = '';
            imageIdArray.forEach((imgId, index) => {
                const fileName = imageList[imgId];
                const annotationCount = (annotationsByImage[imgId] || []).length;
                
                const li = document.createElement('li');
                li.className = 'image-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'image-name';
                nameSpan.textContent = `${imgId} | ${fileName}`;
                
                const badge = document.createElement('span');
                badge.className = 'annotation-badge';
                badge.textContent = annotationCount;
                
                li.appendChild(nameSpan);
                li.appendChild(badge);
                
                li.dataset.imgId = imgId;
                li.dataset.fileName = fileName;
                li.dataset.index = index;
                li.addEventListener('click', () => {
                    currentImageIndex = index;
                    displayImage(imgId, fileName);
                });
                imageListEl.appendChild(li);
            });
        }

        function getColorForCategory(catId) {
            if (!colorMap[catId]) {
                const hash = catId * 37;
                const hue = hash % 360;
                colorMap[catId] = `hsl(${hue}, 80%, 60%)`;
            }
            return colorMap[catId];
        }

        function updateLegend() {
            legendContent.innerHTML = '';
            Object.entries(classMap).forEach(([id, name]) => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = getColorForCategory(parseInt(id));
                
                const label = document.createElement('span');
                label.textContent = name;
                
                div.appendChild(colorBox);
                div.appendChild(label);
                legendContent.appendChild(div);
            });

            if (Object.keys(classMap).length > 0) {
                legend.classList.add('show');
            }
        }

        function updateInfo() {
            document.getElementById('jsonCount').textContent = Object.keys(imageList).length;
            document.getElementById('annotationCount').textContent = allAnnotations.length;
            infoPanel.style.display = 'block';
        }

        async function displayImage(imgId, fileName) {
            document.querySelectorAll('.image-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.imgId === imgId) {
                    el.classList.add('active');
                }
            });

            const baseName = fileName.split('.')[0];
            const imageFile = imageFiles[baseName];

            if (!imageFile) {
                showStatus(`ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${fileName}`, 'error');
                return;
            }

            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                const annotations = annotationsByImage[imgId] || [];
                
                document.getElementById('currentAnnotationCount').textContent = annotations.length;

                annotations.forEach(ann => {
                    let x, y, w, h;
                    
                    // YOLO í¬ë§·
                    if (ann.yolo) {
                        const [centerX, centerY, width, height] = ann.yolo;
                        const actualCenterX = centerX * img.width;
                        const actualCenterY = centerY * img.height;
                        const actualWidth = width * img.width;
                        const actualHeight = height * img.height;
                        
                        x = actualCenterX - actualWidth / 2;
                        y = actualCenterY - actualHeight / 2;
                        w = actualWidth;
                        h = actualHeight;
                    }
                    // COCO/LabelMe í¬ë§·
                    else if (ann.bbox) {
                        [x, y, w, h] = ann.bbox;
                    } else {
                        return;
                    }

                    const catId = ann.category_id || ann.class_id || 0;
                    const color = getColorForCategory(catId);

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x, y, w, h);

                    let label = ann.object_name_kr || ann.label || '';
                    let desc = ann.object_description_kr || '';
                    let combined = '';

                    if (label && desc) {
                        combined = `${label} ${desc}`;
                    } else if (label) {
                        combined = label;
                    } else if (desc) {
                        combined = desc;
                    } else if (classMap[catId]) {
                        combined = classMap[catId];
                    }

                    if (combined) {
                        ctx.font = 'bold 14px sans-serif';
                        const textMetrics = ctx.measureText(combined);
                        const textHeight = 20;
                        const padding = 4;

                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.fillRect(
                            x, 
                            y - textHeight - padding, 
                            textMetrics.width + padding * 2, 
                            textHeight + padding
                        );

                        ctx.fillStyle = 'black';
                        ctx.fillText(combined, x + padding, y - padding - 4);
                    }
                });
            };

            img.src = URL.createObjectURL(imageFile);
        }

        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status show ${type}`;
            setTimeout(() => status.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
